<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets CSV API v2.0</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }
        .button:hover {
            background-color: #45a049;
        }
        .button.refresh {
            background-color: #2196F3;
        }
        .button.refresh:hover {
            background-color: #1976D2;
        }
        .button.info {
            background-color: #FF9800;
        }
        .button.info:hover {
            background-color: #F57C00;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #388e3c;
            background-color: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .performance {
            background-color: #e8f4fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 14px;
        }
        .info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }
        .version {
            background-color: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Google Sheets CSV to JSON API v2.0</h1>
        
        <div class="version">
            ‚ö° New: Local CSV Storage + Ultra-Fast Processing (1ms!)
        </div>
        
        <div class="info">
            <strong>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å:</strong> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏à 27-1-65.xlsx<br>
            <strong>üîó Source:</strong> <a href="https://docs.google.com/spreadsheets/d/174dcynBTIagtj0JckoVh248dXXncdi0I/htmlview#gid=1618426698" target="_blank">Google Sheets</a><br>
            <strong>üíæ Storage:</strong> Local CSV File (ultra-fast access)<br>
            <strong>üîÑ Refresh:</strong> On-demand from Google Sheets
        </div>

        <button class="button" onclick="fetchData()">üì• ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Local CSV</button>
        <button class="button refresh" onclick="refreshData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏à‡∏≤‡∏Å Google Sheets</button>
        <button class="button info" onclick="getFileInfo()">üìÅ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV File</button>
        <button class="button" onclick="testHealth()">‚ù§Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API</button>

        <div id="status"></div>
        <div id="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        
        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function setResult(content) {
            document.getElementById('result').innerHTML = content;
        }

        async function fetchData() {
            setStatus('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Local CSV...', 'loading');
            setResult('');
            
            const startTime = Date.now();
            
            try {
                const response = await fetch(`${API_BASE}/api/data`);
                const data = await response.json();
                
                const clientTime = Date.now() - startTime;
                
                if (data.success) {
                    setStatus(`‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ${data.totalRows} ‡πÅ‡∏ñ‡∏ß`, 'success');
                    
                    // Show performance info
                    const perfInfo = `
                        <div class="performance">
                            ‚ö° <strong>Performance:</strong> Server ${data.processingTime} + Network ${clientTime}ms = Total ${clientTime}ms<br>
                            üìÅ <strong>Source:</strong> ${data.source} (${(data.fileSize/1024).toFixed(1)}KB)<br>
                            üïê <strong>Last Updated:</strong> ${new Date(data.lastUpdated).toLocaleString('th-TH')}
                        </div>
                    `;
                    setResult(perfInfo);
                    
                    displayData(data);
                } else {
                    setStatus(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.error}`, 'error');
                }
            } catch (error) {
                setStatus(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
                console.error('Error:', error);
            }
        }

        async function refreshData() {
            setStatus('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...', 'loading');
            setResult('');
            
            try {
                const response = await fetch(`${API_BASE}/api/refresh`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    setStatus(`‚úÖ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${data.totalRows} ‡πÅ‡∏ñ‡∏ß`, 'success');
                    setResult(`
                        <div class="success">
                            <h3>üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
                            <ul>
                                <li><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß:</strong> ${data.totalRows}</li>
                                <li><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä:</strong> ${new Date(data.refreshTime).toLocaleString('th-TH')}</li>
                                <li><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà:</strong> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</li>
                            </ul>
                            <p><em>‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Local CSV" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</em></p>
                        </div>
                    `);
                } else {
                    setStatus(`‚ùå ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${data.error}`, 'error');
                }
            } catch (error) {
                setStatus(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
            }
        }

        async function getFileInfo() {
            setStatus('üìÅ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV file...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE}/api/info`);
                const data = await response.json();
                
                if (data.success) {
                    setStatus('‚úÖ ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV file ‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    setResult(`
                        <h3>üìÅ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV File</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4>üíæ Local File</h4>
                                <ul>
                                    <li><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${data.csvFile.exists ? '‚úÖ ‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå' : '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå'}</li>
                                    <li><strong>‡∏Ç‡∏ô‡∏≤‡∏î:</strong> ${(data.csvFile.size/1024).toFixed(1)} KB</li>
                                    <li><strong>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${data.csvFile.modified ? new Date(data.csvFile.modified).toLocaleString('th-TH') : 'N/A'}</li>
                                    <li><strong>Path:</strong> <small>${data.csvFile.path}</small></li>
                                </ul>
                            </div>
                            <div>
                                <h4>üí≠ Cache Status</h4>
                                <ul>
                                    <li><strong>‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> ${data.cache.hasData ? '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î'}</li>
                                    <li><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß:</strong> ${data.cache.rowCount}</li>
                                    <li><strong>‡πÇ‡∏´‡∏•‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${data.cache.lastLoaded ? new Date(data.cache.lastLoaded).toLocaleString('th-TH') : 'N/A'}</li>
                                </ul>
                            </div>
                        </div>
                        
                        <h4>üîó Google Sheets Source</h4>
                        <ul>
                            <li><strong>Spreadsheet ID:</strong> ${data.googleSheets.spreadsheetId}</li>
                            <li><strong>Sheet GID:</strong> ${data.googleSheets.sheetGid}</li>
                            <li><strong>CSV URL:</strong> <small>${data.googleSheets.csvUrl}</small></li>
                        </ul>
                    `);
                } else {
                    setStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
                }
            } catch (error) {
                setStatus(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
            }
        }

        async function testHealth() {
            setStatus('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    setStatus('‚úÖ API ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥', 'success');
                    setResult(`
                        <h3>ü©∫ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</h3>
                        <ul>
                            <li><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${data.status}</li>
                            <li><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${new Date(data.timestamp).toLocaleString('th-TH')}</li>
                            <li><strong>Cache:</strong> ${data.cache.hasData ? `‚úÖ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${data.cache.rowCount} ‡πÅ‡∏ñ‡∏ß` : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</li>
                        </ul>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `);
                } else {
                    setStatus('‚ö†Ô∏è API ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', 'error');
                }
            } catch (error) {
                setStatus(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
            }
        }

        function displayData(apiResponse) {
            const data = apiResponse.data;
            
            if (!data || data.length === 0) {
                setResult(document.getElementById('result').innerHTML + '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>');
                return;
            }

            // Create table
            let tableHTML = `
                <h3>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Pure Soft (${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
                <table>
                    <thead>
                        <tr>
            `;

            // Get headers from first row
            const headers = Object.keys(data[0]);
            headers.slice(0, 4).forEach(header => { // Show first 4 columns only
                const displayHeader = header.includes('pure soft') ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 
                                    header === '' ? '‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå' : header;
                tableHTML += `<th>${displayHeader}</th>`;
            });

            tableHTML += `
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Add data rows (skip header rows, show products only)
            data.slice(3).forEach(row => { // Skip first 3 header rows
                const values = Object.values(row).slice(0, 4);
                if (values[0] && values[0].match(/^\d+$/)) { // Only show product rows
                    tableHTML += '<tr>';
                    values.forEach(value => {
                        const displayValue = value ? value.substring(0, 100) + (value.length > 100 ? '...' : '') : '';
                        tableHTML += `<td>${displayValue}</td>`;
                    });
                    tableHTML += '</tr>';
                }
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            // Add raw JSON data
            const rawData = `
                <h3>üîß Complete API Response</h3>
                <pre>${JSON.stringify(apiResponse, null, 2)}</pre>
            `;

            const currentResult = document.getElementById('result').innerHTML;
            setResult(currentResult + tableHTML + rawData);
        }

        // Auto-load data when page loads
        window.addEventListener('load', () => {
            setTimeout(fetchData, 500);
        });
    </script>
</body>
</html>